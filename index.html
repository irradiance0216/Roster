function runScheduler() {
    const container = document.getElementById('timeline');
    const scale = document.getElementById('rScale');
    container.innerHTML = ''; scale.innerHTML = '';
    
    const dayStart = Math.min(...staff.map(s => s.start));
    const dayEnd = Math.max(...staff.map(s => s.end));
    const span = dayEnd - dayStart;

    // Reset workers
    staff.forEach(s => { 
        s.tasks = []; 
        s.busyUntil = s.start; 
        s.fatigue = 0; 
    });

    // Sort positions by start time to process the day chronologically
    const sortedPositions = [...positions].sort((a, b) => a.start - b.start);

    sortedPositions.forEach(pos => {
        // Find ALL workers who are on duty and not busy
        let availableWorkers = staff.filter(s => 
            s.start <= pos.start && 
            s.end >= pos.end && 
            s.busyUntil <= pos.start
        );

        if (availableWorkers.length > 0) {
            // Pick the worker with the LOWEST current fatigue score
            availableWorkers.sort((a, b) => a.fatigue - b.fatigue);
            
            let bestWorker = availableWorkers[0];
            bestWorker.tasks.push(pos);
            bestWorker.busyUntil = pos.end;
            bestWorker.fatigue += (pos.end - pos.start) * pos.weight;
        }
    });

    // --- RENDER LOGIC (Keep the same as previous version) ---
    staff.forEach(s => {
        const row = document.createElement('div');
        row.className = 'worker-row';
        let trackHtml = '';
        s.tasks.forEach(t => {
            const left = ((t.start - dayStart) / span) * 100;
            const width = ((t.end - t.start) / span) * 100;
            trackHtml += `<div class="block" style="left:${left}%; width:${width}%; background:${getColor(t.weight)}">${t.name}<br>${t.weight}x</div>`;
        });
        row.innerHTML = `<div class="worker-info"><b>${s.name}</b><br><small>Duty: ${decToTime(s.start)}-${decToTime(s.end)}</small></div><div class="track">${trackHtml}</div>`;
        container.appendChild(row);
    });

    for (let h = dayStart; h <= dayEnd; h++) {
        scale.innerHTML += `<div style="flex:1; border-left:1px solid #ddd; padding-left:4px;">${h}:00</div>`;
    }

    renderStats();
    document.getElementById('resultSection').style.display = 'block';
}

function renderStats() {
    let statsHtml = `<table><tr><th>Staff</th><th>Actual Work</th><th>Fatigue Score</th><th>Calculated Break</th><th>Status</th></tr>`;
    staff.forEach(s => {
        const work = s.tasks.reduce((sum, t) => sum + (t.end - t.start), 0);
        const brk = (s.end - s.start) - work;
        const status = brk < 1.5 ? '<span class="warn">Low Break</span>' : 'âœ… Healthy';
        statsHtml += `<tr><td>${s.name}</td><td>${work.toFixed(1)}h</td><td>${s.fatigue.toFixed(1)}</td><td>${brk.toFixed(2)}h</td><td>${status}</td></tr>`;
    });
    document.getElementById('statsTable').innerHTML = statsHtml + `</table>`;
}
