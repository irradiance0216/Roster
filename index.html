<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manning Pro: 15-Min Granular Scheduler</title>
    <style>
        :root { --primary: #2563eb; --work: #3b82f6; --break: #e2e8f0; --text: #1e293b; --danger: #ef4444; }
        body { font-family: 'Inter', system-ui, sans-serif; background: #f1f5f9; color: var(--text); margin: 0; padding: 20px; }
        section { background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 1.5rem; }
        
        .grid-inputs { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; align-items: end; }
        input { padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; width: 100%; box-sizing: border-box; }
        label { display: block; font-size: 11px; font-weight: 700; margin-bottom: 5px; text-transform: uppercase; color: #64748b; }
        
        /* The Chart */
        .chart-container { overflow-x: auto; background: white; padding: 20px; border-radius: 12px; border: 1px solid #e2e8f0; }
        .schedule-grid { display: grid; grid-template-columns: 120px repeat(96, 25px); border-collapse: collapse; }
        .cell { height: 30px; border: 1px solid #f1f5f9; display: flex; align-items: center; justify-content: center; font-size: 9px; }
        .time-header { position: sticky; top: 0; background: white; font-weight: bold; z-index: 10; border-bottom: 2px solid #cbd5e1; }
        .worker-name { position: sticky; left: 0; background: #f8fafc; font-weight: bold; border-right: 2px solid #cbd5e1; z-index: 5; }
        
        .status-work { background: var(--work); color: white; }
        .status-break { background: var(--break); color: #94a3b8; }
        .status-off { background: #f1f5f9; opacity: 0.3; }
        .status-gap { background: var(--danger); color: white; animation: blink 1s infinite; }
        
        @keyframes blink { 50% { opacity: 0.5; } }
        button { padding: 12px 20px; cursor: pointer; background: var(--primary); color: white; border: none; border-radius: 6px; font-weight: 700; width: 100%; margin: 10px 0; }
        .legend { display: flex; gap: 20px; margin-bottom: 10px; font-size: 12px; }
    </style>
</head>
<body>

    <section>
        <h2>1. Team Availability</h2>
        <div class="grid-inputs">
            <div><label>Name</label><input type="text" id="sName"></div>
            <div><label>Duty In</label><input type="time" id="sStart" value="09:00"></div>
            <div><label>Duty Out</label><input type="time" id="sEnd" value="17:00"></div>
            <button onclick="addStaff()">Add Staff</button>
        </div>
        <div id="staffList"></div>
    </section>

    <section>
        <h2>2. Positions Needed</h2>
        <div class="grid-inputs">
            <div><label>Position</label><input type="text" id="pName"></div>
            <div><label>Start</label><input type="time" id="pStart"></div>
            <div><label>End</label><input type="time" id="pEnd"></div>
            <button onclick="addPosition()">Add Position</button>
        </div>
        <div id="pList"></div>
    </section>

    <button onclick="runScheduler()">ðŸ”„ GENERATE 15-MINUTE ROTATION</button>

    <div class="legend">
        <div><span style="display:inline-block;width:12px;height:12px;background:var(--work)"></span> Work</div>
        <div><span style="display:inline-block;width:12px;height:12px;background:var(--break)"></span> Break (On-Duty)</div>
        <div><span style="display:inline-block;width:12px;height:12px;background:#f1f5f9"></span> Off-Duty</div>
    </div>

    <div class="chart-container" id="chartOutput"></div>

    <script>
        let staff = JSON.parse(localStorage.getItem('staff_v8')) || [];
        let positions = JSON.parse(localStorage.getItem('positions_v8')) || [];
        
        const t2m = t => { const [h, m] = t.split(':').map(Number); return h * 60 + m; };
        const m2t = m => `${Math.floor(m/60).toString().padStart(2,'0')}:${(m%60).toString().padStart(2,'0')}`;

        function addStaff() {
            staff.push({ name: document.getElementById('sName').value, start: t2m(document.getElementById('sStart').value), end: t2m(document.getElementById('sEnd').value) });
            updateLists();
        }
        function addPosition() {
            positions.push({ name: document.getElementById('pName').value, start: t2m(document.getElementById('pStart').value), end: t2m(document.getElementById('pEnd').value) });
            updateLists();
        }
        function updateLists() {
            localStorage.setItem('staff_v8', JSON.stringify(staff));
            localStorage.setItem('positions_v8', JSON.stringify(positions));
            document.getElementById('staffList').innerHTML = staff.map((s,i)=>`<div>${s.name} (${m2t(s.start)}-${m2t(s.end)}) <button onclick="staff.splice(${i},1);updateLists()">Ã—</button></div>`).join('');
            document.getElementById('pList').innerHTML = positions.map((p,i)=>`<div>${p.name} (${m2t(p.start)}-${m2t(p.end)}) <button onclick="positions.splice(${i},1);updateLists()">Ã—</button></div>`).join('');
        }

        function runScheduler() {
            const container = document.getElementById('chartOutput');
            container.innerHTML = '';
            
            const grid = document.createElement('div');
            grid.className = 'schedule-grid';

            // Headers: Time slots (00:00 to 23:45)
            grid.appendChild(Object.assign(document.createElement('div'), { className: 'cell time-header', innerText: 'Time' }));
            for(let m=0; m<1440; m+=15) {
                const h = grid.appendChild(document.createElement('div'));
                h.className = 'cell time-header';
                h.innerText = m % 60 === 0 ? m2t(m) : '';
            }

            // Initialization
            staff.forEach(s => { s.schedule = new Array(96).fill('off'); s.minutesWorked = 0; });
            const intervals = 96; // 24 hours / 15 mins

            // Processing every 15-minute slot
            for (let i = 0; i < intervals; i++) {
                const currentTime = i * 15;
                
                // 1. Find which positions need coverage right now
                let activePositions = positions.filter(p => currentTime >= p.start && currentTime < p.end);
                
                // 2. Find who is actually on duty right now
                let onDutyStaff = staff.filter(s => currentTime >= s.start && currentTime < s.end);
                
                // Set everyone on duty to 'break' by default for this slot
                onDutyStaff.forEach(s => s.schedule[i] = 'break');

                // 3. Assign work to the ones who have worked the LEAST so far
                activePositions.forEach(pos => {
                    let availableForWork = onDutyStaff.filter(s => s.schedule[i] === 'break');
                    if (availableForWork.length > 0) {
                        availableForWork.sort((a, b) => a.minutesWorked - b.minutesWorked);
                        let worker = availableForWork[0];
                        worker.schedule[i] = 'work';
                        worker.minutesWorked += 15;
                    } else {
                        // Gap handling could be added here
                    }
                });
            }

            // Render Rows
            staff.forEach(s => {
                const nameLabel = document.createElement('div');
                nameLabel.className = 'cell worker-name';
                nameLabel.innerText = s.name;
                grid.appendChild(nameLabel);

                s.schedule.forEach(status => {
                    const c = document.createElement('div');
                    c.className = `cell status-${status}`;
                    grid.appendChild(c);
                });
            });

            container.appendChild(grid);
        }
        updateLists();
    </script>
</body>
</html>
